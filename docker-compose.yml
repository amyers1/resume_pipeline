services:
    api:
        build: .
        container_name: resume-api
        ports:
            - "8000:8000"
        environment:
            - USER_ID=${USER_ID:-1000}
            - GROUP_ID=${GROUP_ID:-1000}
            - ENABLE_RABBITMQ=true
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
        env_file:
            - .env
        volumes:
            - ./career_profile.json:/app/career_profile.json:ro
            - ./.env:/app/.env:ro
            - ./output:/app/output:rw
            - ./jobs:/app/jobs:rw
            - ./templates:/app/templates:ro
        command: uvicorn api:app --host 0.0.0.0 --port 8000 --reload
        depends_on:
            rabbitmq:
                condition: service_healthy
        restart: unless-stopped

        # Worker Pool (scalable)
    worker:
        build: .
        environment:
            - USER_ID=${USER_ID:-1000}
            - GROUP_ID=${GROUP_ID:-1000}
            - ENABLE_RABBITMQ=true
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
        env_file:
            - .env
        volumes:
            - ./career_profile.json:/app/career_profile.json:ro
            - ./.env:/app/.env:ro
            - ./output:/app/output:rw
            - ./jobs:/app/jobs:ro
            - ./templates:/app/templates:ro
        command: python resume_worker.py
        depends_on:
            rabbitmq:
                condition: service_healthy
        restart: unless-stopped
        deploy:
            replicas: 2
