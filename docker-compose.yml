services:
    api:
        build: .
        container_name: resume-pipeline-api
        ports:
            - "8000:8000"
        environment:
            - USER_ID=${USER_ID:-1000}
            - GROUP_ID=${GROUP_ID:-1000}
            - ENABLE_RABBITMQ=${ENABLE_RABBITMQ:-false}
            - RABBITMQ_HOST=${RABBITMQ_HOST:-}
            - RABBITMQ_PORT=${RABBITMQ_PORT:-}
        env_file:
            - .env
        volumes:
            - ./career_profile.json:/app/career_profile.json:ro
            - ./.env:/app/.env:ro
            - ./jobs:/app/jobs
            - ./output:/app/output
            - ./profiles:/app/profiles
            - ./api.py:/app/api.py
            - ./resume_pipeline_rabbitmq.py:/app/resume_pipeline_rabbitmq.py
        command: uvicorn api:app --host 0.0.0.0 --port 8000 --reload
        # depends_on:
        #     rabbitmq:
        #         condition: service_healthy
        restart: unless-stopped

        # Worker Pool (scalable)
    worker:
        build: .
        user: "${UID:-1000}:${GID:-1000}"
        environment:
            - USER_ID=${USER_ID:-1000}
            - GROUP_ID=${GROUP_ID:-1000}
            - ENABLE_RABBITMQ=${ENABLE_RABBITMQ:-false}
            - RABBITMQ_HOST=${RABBITMQ_HOST:-}
            - RABBITMQ_PORT=${RABBITMQ_PORT:-}
        env_file:
            - .env
        volumes:
            - ./.env:/app/.env:ro
            - ./career_profile.json:/app/career_profile.json:ro
            - ./jobs:/app/jobs
            - ./output:/app/output
            - ./profiles:/app/profiles
            - ./resume_worker.py:/app/resume_worker.py
            - ./resume_pipeline_rabbitmq.py:/app/resume_pipeline_rabbitmq.py
        command: python resume_worker.py
        # depends_on:
        #     rabbitmq:
        #         condition: service_healthy
        restart: unless-stopped
        deploy:
            replicas: 2
