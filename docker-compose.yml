services:
    # Redis Cache Server
    redis:
        image: redis:7-alpine
        user: "${UID:-1000}:${GID:-1000}"
        container_name: resume-redis
        ports:
            - "6379:6379"
        volumes:
            - ./data/redis:/data
        command: redis-server --appendonly yes
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 3
        restart: unless-stopped
    api:
        build: .
        container_name: resume-pipeline-api
        ports:
            - "8000:8000"
        environment:
            - REDIS_HOST=${REDIS_HOST:-redis}
            - USER_ID=${USER_ID:-1000}
            - GROUP_ID=${GROUP_ID:-1000}
            - ENABLE_RABBITMQ=${ENABLE_RABBITMQ:-false}
            - RABBITMQ_HOST=${RABBITMQ_HOST:-}
            - RABBITMQ_PORT=${RABBITMQ_PORT:-}
        env_file:
            - .env
        volumes:
            - ./career_profile.json:/app/career_profile.json:ro
            - ./.env:/app/.env:ro
            - ./jobs:/app/jobs
            - ./output:/app/output
            - ./profiles:/app/profiles
            - ./api.py:/app/api.py
            - ./resume_pipeline_rabbitmq.py:/app/resume_pipeline_rabbitmq.py
        command: uvicorn api:app --host 0.0.0.0 --port 8000 --reload
        depends_on:
            redis:
                condition: service_healthy
        restart: unless-stopped

        # Worker Pool (scalable)
    worker:
        build: .
        environment:
            - REDIS_HOST=${REDIS_HOST:-redis}
            - USER_ID=${USER_ID:-1000}
            - GROUP_ID=${GROUP_ID:-1000}
            - ENABLE_RABBITMQ=${ENABLE_RABBITMQ:-false}
            - RABBITMQ_HOST=${RABBITMQ_HOST:-}
            - RABBITMQ_PORT=${RABBITMQ_PORT:-}
        env_file:
            - .env
        volumes:
            - ./.env:/app/.env:ro
            - ./career_profile.json:/app/career_profile.json:ro
            - ./jobs:/app/jobs
            - ./output:/app/output
            - ./profiles:/app/profiles
            - ./resume_worker.py:/app/resume_worker.py
            - ./resume_pipeline_rabbitmq.py:/app/resume_pipeline_rabbitmq.py
        command: python resume_worker.py
        depends_on:
            redis:
                condition: service_healthy
        restart: unless-stopped
        deploy:
            replicas: 2

    # Frontend
    frontend:
        build: ./frontend
        container_name: resume-pipeline-frontend
        ports:
            - "3000:80"
        depends_on:
            - api
        restart: unless-stopped

networks:
    default:
        name: resume-pipeline-network
